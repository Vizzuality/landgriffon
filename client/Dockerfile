FROM node:20.14-bullseye-slim

WORKDIR /app

ARG UID=5000
ARG GID=5000
ARG NEXTAUTH_URL
ARG NEXTAUTH_SECRET
ARG NEXT_PUBLIC_API_URL
ARG CYPRESS_USERNAME
ARG CYPRESS_PASSWORD

ENV NAME landgriffon-client
ENV USER $NAME
ENV APP_HOME /opt/$NAME
ENV NEXTAUTH_URL $NEXTAUTH_URL
ENV NEXTAUTH_SECRET $NEXTAUTH_SECRET
ENV NEXT_PUBLIC_API_URL $NEXT_PUBLIC_API_URL
ENV NEXT_TELEMETRY_DISABLED 1
ENV CYPRESS_USERNAME $CYPRESS_USERNAME
ENV CYPRESS_PASSWORD $CYPRESS_PASSWORD
ENV CYPRESS_API_URL $NEXT_PUBLIC_API_URL

COPY package.json pnpm-workspace.yaml pnpm-lock.yaml ./
COPY client ./client

RUN corepack enable pnpm
RUN pnpm client:deps
RUN pnpm client:build

EXPOSE 3000
ENTRYPOINT ["./entrypoint.sh"]
